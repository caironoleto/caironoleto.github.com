---
layout: post
title: Usando Factory Girl em seus testes
---

<p>Hoje quem desenvolve em Ruby On Rails tem nas mãos as poderosas ferramentas de testes, sejam eles para desenvolvimento orientado a testes ou orientado a comportamentos. E no início nós usávamos fixtures, que são arquivos que contém um amontoado de dados que serão usados em nossos testes.



Junto com a evolução dessas ferramentas nasceram os <em><a title="Rails Fixtures Replacements" href="http://ruby-toolbox.com/categories/rails_fixture_replacement.html" target="_blank">fixtures replacements</a></em>. Nasceram para suprir a necessidade de organização e praticidade na utilização de fixtures. Atualmente temos <a href="http://github.com/technoweenie/machinist/tree/master" target="_blank">Machinist</a>, <a href="http://github.com/thoughtbot/factory_girl" target="_blank">Factory Girl</a>, <a href="http://github.com/flogic/object_daddy" target="_blank">Object Daddy</a>, <a href="http://github.com/aiwilliams/dataset" target="_blank">Dataset</a>, <a href="http://github.com/nakajima/fixjour" target="_blank">Fixjour</a> e <a href="http://github.com/smtlaissezfaire/fixturereplacement" target="_blank">FixtureReplacement</a>. Certamente existem outros, mas esses são os mais famosos e usados.



Hoje vou mostrar como você pode usar o Factory Girl em seus testes/especificações.



Para instalar o Factory Girl:

<blockquote><em>sudo gem install thoughtbot-factory_girl</em></blockquote>

Depois você tem que configurar no seu environment o uso da gem:

<blockquote><em>config.gem &#8220;thoughtbot-factory_girl&#8221;, :lib =&gt; &#8220;factory_girl&#8221;, :source =&gt; &#8220;http://gems.github.com&#8221;</em></blockquote>

Depois de configurado, vamos a criação de suas factories. Por padrão, o Factory Girl carrega automaticamente em seus testes as factories que se encontram em test/factories/*.rb, spec/factories/*.rb ou você pode criar todos os seus factories em um único arquivo e colocar em test/factories.rb ou spec/factories.rb. Você pode criar todos os seus factories em um único arquivo ou separar por model (O que eu acho mais organizado).



Antes de usar o Factory Girl nos seus testes você deve definir como cada model deve funcionar:

<pre class="textmate-source merbivore"><span class="source source_ruby"><span class="support support_class support_class_ruby">Factory</span><span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>define <span class="constant constant_other constant_other_symbol constant_other_symbol_ruby"><span class="punctuation punctuation_definition punctuation_definition_constant punctuation_definition_constant_ruby">:</span>user</span> <span class="keyword keyword_control keyword_control_start-block keyword_control_start-block_ruby">do </span><span class="punctuation punctuation_separator punctuation_separator_variable punctuation_separator_variable_ruby">|</span><span class="variable variable_other variable_other_block variable_other_block_ruby">factory</span><span class="punctuation punctuation_separator punctuation_separator_variable punctuation_separator_variable_ruby">|</span>

  factory<span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>name <span class="punctuation punctuation_separator punctuation_separator_key-value">=&gt;</span> <span class="string string_quoted string_quoted_double string_quoted_double_ruby"><span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_begin punctuation_definition_string_begin_ruby">"</span>Cairo<span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_end punctuation_definition_string_end_ruby">"</span></span>

  factory<span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>surname <span class="punctuation punctuation_separator punctuation_separator_key-value">=&gt;</span> <span class="string string_quoted string_quoted_double string_quoted_double_ruby"><span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_begin punctuation_definition_string_begin_ruby">"</span>Noleto<span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_end punctuation_definition_string_end_ruby">"</span></span>

<span class="keyword keyword_control keyword_control_ruby">end</span></span></pre>

Você pode ter outras definições, por exemplo:

<pre class="textmate-source merbivore"><span class="source source_ruby"><span class="support support_class support_class_ruby">Factory</span><span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>define <span class="constant constant_other constant_other_symbol constant_other_symbol_ruby"><span class="punctuation punctuation_definition punctuation_definition_constant punctuation_definition_constant_ruby">:</span>admin</span><span class="punctuation punctuation_separator punctuation_separator_object punctuation_separator_object_ruby">,</span> <span class="constant constant_other constant_other_symbol constant_other_symbol_ruby"><span class="punctuation punctuation_definition punctuation_definition_constant punctuation_definition_constant_ruby">:</span>class</span> <span class="punctuation punctuation_separator punctuation_separator_key-value">=&gt;</span> <span class="variable variable_other variable_other_constant variable_other_constant_ruby">User</span> <span class="keyword keyword_control keyword_control_start-block keyword_control_start-block_ruby">do </span><span class="punctuation punctuation_separator punctuation_separator_variable punctuation_separator_variable_ruby">|</span><span class="variable variable_other variable_other_block variable_other_block_ruby">factory</span><span class="punctuation punctuation_separator punctuation_separator_variable punctuation_separator_variable_ruby">|</span>

  factory<span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>name <span class="punctuation punctuation_separator punctuation_separator_key-value">=&gt;</span> <span class="string string_quoted string_quoted_double string_quoted_double_ruby"><span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_begin punctuation_definition_string_begin_ruby">"</span>Administrador<span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_end punctuation_definition_string_end_ruby">"</span></span>

  factory<span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>surname <span class="punctuation punctuation_separator punctuation_separator_key-value">=&gt;</span> <span class="string string_quoted string_quoted_double string_quoted_double_ruby"><span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_begin punctuation_definition_string_begin_ruby">"</span>Cairo Noleto<span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_end punctuation_definition_string_end_ruby">"</span></span>

  factory<span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>admin <span class="punctuation punctuation_separator punctuation_separator_key-value">=&gt;</span> <span class="constant constant_language constant_language_ruby">true</span>

<span class="keyword keyword_control keyword_control_ruby">end</span></span></pre>

Você pode fazer vários tipos de factories, um para cada situação que você precisar, é mais fácil para fazer a manutenção.



Depois que você define suas factories é hora de realmente brincar com elas ;)

<pre class="textmate-source merbivore"><span class="source source_ruby">user <span class="keyword keyword_operator keyword_operator_assignment keyword_operator_assignment_ruby">=</span> <span class="support support_class support_class_ruby">Factory</span><span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>build<span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">(</span><span class="constant constant_other constant_other_symbol constant_other_symbol_ruby"><span class="punctuation punctuation_definition punctuation_definition_constant punctuation_definition_constant_ruby">:</span>user</span><span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">)</span>

user_admin <span class="keyword keyword_operator keyword_operator_assignment keyword_operator_assignment_ruby">=</span> <span class="support support_class support_class_ruby">Factory</span><span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>build<span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">(</span><span class="constant constant_other constant_other_symbol constant_other_symbol_ruby"><span class="punctuation punctuation_definition punctuation_definition_constant punctuation_definition_constant_ruby">:</span>admin</span><span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">)</span></span></pre>

Quando você usa build, ele constroi um objeto não salvo.

<pre class="textmate-source merbivore"><span class="source source_ruby">user <span class="keyword keyword_operator keyword_operator_assignment keyword_operator_assignment_ruby">=</span> <span class="support support_class support_class_ruby">Factory</span><span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>create<span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">(</span><span class="constant constant_other constant_other_symbol constant_other_symbol_ruby"><span class="punctuation punctuation_definition punctuation_definition_constant punctuation_definition_constant_ruby">:</span>user</span><span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">)</span>

user_admin <span class="keyword keyword_operator keyword_operator_assignment keyword_operator_assignment_ruby">=</span> <span class="support support_class support_class_ruby">Factory</span><span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>create<span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">(</span><span class="constant constant_other constant_other_symbol constant_other_symbol_ruby"><span class="punctuation punctuation_definition punctuation_definition_constant punctuation_definition_constant_ruby">:</span>admin</span><span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">)</span></span></pre>

Ao utilizar create, você está criando um objeto salvo.



Você pode criar uma hash com os atributos:

<pre class="textmate-source merbivore"><span class="source source_ruby">admin_attributes <span class="keyword keyword_operator keyword_operator_assignment keyword_operator_assignment_ruby">=</span> <span class="support support_class support_class_ruby">Factory</span><span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>attributes_for<span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">(</span><span class="constant constant_other constant_other_symbol constant_other_symbol_ruby"><span class="punctuation punctuation_definition punctuation_definition_constant punctuation_definition_constant_ruby">:</span>admin</span><span class="punctuation punctuation_section punctuation_section_function punctuation_section_function_ruby">)</span></span></pre>

Você pode definir associações:

<pre class="textmate-source merbivore"><span class="source source_ruby source_ruby_rails"><span class="support support_class support_class_ruby">Factory</span><span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>define <span class="constant constant_other constant_other_symbol constant_other_symbol_ruby"><span class="punctuation punctuation_definition punctuation_definition_constant punctuation_definition_constant_ruby">:</span>picture</span> <span class="keyword keyword_control keyword_control_start-block keyword_control_start-block_ruby">do </span><span class="punctuation punctuation_separator punctuation_separator_variable punctuation_separator_variable_ruby">|</span><span class="variable variable_other variable_other_block variable_other_block_ruby">factory</span><span class="punctuation punctuation_separator punctuation_separator_variable punctuation_separator_variable_ruby">|</span>

  factory<span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>name <span class="string string_quoted string_quoted_double string_quoted_double_ruby"><span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_begin punctuation_definition_string_begin_ruby">"</span>Random name<span class="punctuation punctuation_definition punctuation_definition_string punctuation_definition_string_end punctuation_definition_string_end_ruby">"</span></span>

  factory<span class="punctuation punctuation_separator punctuation_separator_method punctuation_separator_method_ruby">.</span>association <span class="constant constant_other constant_other_symbol constant_other_symbol_ruby"><span class="punctuation punctuation_definition punctuation_definition_constant punctuation_definition_constant_ruby">:</span>user</span><span class="punctuation punctuation_separator punctuation_separator_object punctuation_separator_object_ruby">,</span> <span class="constant constant_other constant_other_symbol constant_other_symbol_ruby"><span class="punctuation punctuation_definition punctuation_definition_constant punctuation_definition_constant_ruby">:</span>factory</span> <span class="punctuation punctuation_separator punctuation_separator_key-value">=&gt;</span> <span class="constant constant_other constant_other_symbol constant_other_symbol_ruby"><span class="punctuation punctuation_definition punctuation_definition_constant punctuation_definition_constant_ruby">:</span>user</span>

<span class="keyword keyword_control keyword_control_ruby">end</span></span></pre>

Basicamente o Factory Girl é isso, dessa forma você já pode abandonar as fixtures. Existe mais opções de uso do Factory Girl que você pode olhar a <a title="Documentação do Factory Girl" href="http://rdoc.info/projects/thoughtbot/factory_girl" target="_blank">documentação oficial</a>.</p>
